unit URotinaAPICEP;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Buttons, IPPeerClient,
  REST.Client, Data.Bind.Components, Data.Bind.ObjectScope, Rest.JSON, System.Json;

type
  TFRotinaAPICEP = class(TForm)
    ECEP: TEdit;
    BBPesquisar: TBitBtn;
    BBLevar: TBitBtn;
    MJSON: TMemo;
    LCEP: TLabel;
    LJSON: TLabel;
    RESTClient1: TRESTClient;
    RESTRequest1: TRESTRequest;
    RESTResponse1: TRESTResponse;
    LLogradouro: TLabel;
    LComplemento: TLabel;
    LBairro: TLabel;
    LCidade: TLabel;
    LUF: TLabel;
    ELogradouro: TEdit;
    EComplemento: TEdit;
    EBairro: TEdit;
    ECidade: TEdit;
    EUF: TEdit;
    procedure BBPesquisarClick(Sender: TObject);
    procedure BBLevarClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

Const cURL1  = 'viacep.com.br/ws/_numero_CEP/json/';
      cURLP1 = 'viacep.com.br/ws/';
      cURLP2 = '/json/';
var
  FRotinaAPICEP: TFRotinaAPICEP;

implementation

{$R *.dfm}

uses ConstWK, UClaCEPAPI;

procedure TFRotinaAPICEP.BBLevarClick(Sender: TObject);
begin
  Close;
end;

procedure TFRotinaAPICEP.BBPesquisarClick(Sender: TObject);
var JSON : String;
    CEPApi : TCEPAPI;
begin
  if Trim(ECEP.Text) = Empty then
  begin
    beep;
    ShowMessage('Atenção!!'+cEOL+'Necessário informar o CEP.');
    ECEP.SetFocus;
    Exit;
  end;

  RESTClient1.BaseURL := cURLP1+ECEP.Text+cURLP2;
  RESTRequest1.Execute;

  MJSON.Lines.Clear;
  ELogradouro.Clear;
  EComplemento.Clear;
  EBairro.Clear;
  ECidade.Clear;
  EUF.Clear;

  try
    MJSON.Lines.Add(RESTRequest1.Response.JSONValue.ToString);
    JSON := MJSON.Text;
    CEPApi := TJson.JsonToObject<TCEPAPI>(Trim(JSON));
    Try
      ELogradouro.Text  := CEPApi.logradouro;
      EComplemento.Text := CEPApi.complemento;
      EBairro.Text      := CEPApi.bairro;
      ECidade.Text      := CEPApi.localidade;
      EUF.Text          := CEPApi.uf;
    Finally
      CEPApi.Free;
    End;
  except
    begin
      beep;
      ShowMessage('Não foi possível conexão com a API! '+cEOL+
                  '1.Verifique a conexão da internet;'+cEOL+
                  '2.Verifique o código do CEP.');
    end;
  end;
end;

end.
